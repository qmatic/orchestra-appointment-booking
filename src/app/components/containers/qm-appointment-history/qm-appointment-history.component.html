<div class="qm-app">
  <qm-page-header></qm-page-header>
  <qm-main>
    <div class="" style="height: 30%; width: 30%; margin: 10px 20px">
      <qm-customer-search
        *ngIf="currentCustomer === null; else customerCard"
        [addButton]="false"
      ></qm-customer-search>
      <ng-template #customerCard>
        <qm-customer-card [customer]="currentCustomer" style="width: max-content;"></qm-customer-card>
      </ng-template>
    </div>
    
    <div class="qm-app-list-table-container">
      <div *ngIf="!selectedAppointment && currentCustomer">
        <h2 class="qm-app-list-table-container__heading"  *ngIf="currentCustomer && appointments && appointments.length > 0">Appointments</h2>
        <div class="qm-app-list-table-container__filters" *ngIf="currentCustomer && appointments && appointments.length > 0">
          <div>
            Search <input type="text" (change)="onSearchTxtChanged()" (keyup) = "onSearchTxtChanged()" [(ngModel)] = "searchText">
          </div>
          <div>
            show <select name="" id="" (change)="onChangeElementsPerpage($event.target.value)" >
              <option value="5"> 5 </option>
              <option value="10"> 10 </option>
              <option value="20"> 20 </option>
            </select>
          </div>
        </div>
        <hr>
    
        
        <div class="qm-app-list-table-container-list"  *ngIf="currentCustomer && appointments && appointments.length > 0">
          <table id="app-list">
            <tr>
              <th>
                Action Date
                <button class="qm-transparent-btn" (click) = "sortByChange('DATE')">
                  <i class="sort-icon" [ngClass]="((sortByCondition === 'DATE' && sortByAsc) || (sortByCondition !== 'DATE' && !sortByAsc)) ? 'icon-caret-down': 'icon-caret-up'"></i>
                  <!-- <span class="sr-only">{{ sortByVisitIdAsc ? ('button.sortASC' | translate) : ('button.sortDES' | translate) }}</span> -->
                </button>
              </th>
              <th>Operation
                <button class="qm-transparent-btn" (click) = "sortByChange('OPERATION')">
                  <i class="sort-icon" [ngClass]="((sortByCondition === 'START' && sortByAsc) || (sortByCondition !== 'START' && !sortByAsc)) ? 'icon-caret-down': 'icon-caret-up'"></i>
                  <!-- <span class="sr-only">{{ sortByVisitIdAsc ? ('button.sortASC' | translate) : ('button.sortDES' | translate) }}</span> -->
                </button>            
              </th>
              <th>Appt Id
                <button class="qm-transparent-btn" (click) = "sortByChange('APP_ID')">
                  <i class="sort-icon" [ngClass]="((sortByCondition === 'END' && sortByAsc) || (sortByCondition !== 'END' && !sortByAsc)) ? 'icon-caret-down': 'icon-caret-up'"></i>
                  <!-- <span class="sr-only">{{ sortByVisitIdAsc ? ('button.sortASC' | translate) : ('button.sortDES' | translate) }}</span> -->
                </button> 
              </th>
              <th>Start Time
                <button class="qm-transparent-btn" (click) = "sortByChange('START')">
                  <i class="sort-icon" [ngClass]="((sortByCondition === 'FIRST_NAME' && sortByAsc) || (sortByCondition !== 'FIRST_NAME' && !sortByAsc))  ? 'icon-caret-down': 'icon-caret-up'"></i>
                  <!-- <span class="sr-only">{{ sortByVisitIdAsc ? ('button.sortASC' | translate) : ('button.sortDES' | translate) }}</span> -->
                </button> 
              </th>
              <th>End Time
                <button class="qm-transparent-btn" (click) = "sortByChange('END')">
                  <i class="sort-icon" [ngClass]="((sortByCondition === 'LAST_NAME' && sortByAsc) || (sortByCondition !== 'LAST_NAME' && !sortByAsc)) ? 'icon-caret-down': 'icon-caret-up'"></i>
                  <!-- <span class="sr-only">{{ sortByVisitIdAsc ? ('button.sortASC' | translate) : ('button.sortDES' | translate) }}</span> -->
                </button> 
              </th>
              <th>Branch
                <button class="qm-transparent-btn" (click) = "sortByChange('BRANCH')">
                  <i class="sort-icon" [ngClass]="((sortByCondition === 'RESOURCE' && sortByAsc) || (sortByCondition !== 'RESOURCE' && !sortByAsc)) ? 'icon-caret-down': 'icon-caret-up'"></i>
                  <!-- <span class="sr-only">{{ sortByVisitIdAsc ? ('button.sortASC' | translate) : ('button.sortDES' | translate) }}</span> -->
                </button> 
              </th>
              <th>Resource
                <button class="qm-transparent-btn" (click) = "sortByChange('RESOURCE')">
                  <i class="sort-icon" [ngClass]="((sortByCondition === 'NOTE' && sortByAsc) || (sortByCondition !== 'NOTE' && !sortByAsc)) ? 'icon-caret-down': 'icon-caret-up'"></i>
                  <!-- <span class="sr-only">{{ sortByVisitIdAsc ? ('button.sortASC' | translate) : ('button.sortDES' | translate) }}</span> -->
                </button> 
              </th>
              <th>Services
                <button class="qm-transparent-btn" (click) = "sortByChange('SERVICES')">
                  <i class="sort-icon" [ngClass]="((sortByCondition === 'SERVICES' && sortByAsc) || (sortByCondition !== 'SERVICES' && !sortByAsc)) ? 'icon-caret-down': 'icon-caret-up'"></i>
                  <!-- <span class="sr-only">{{ sortByVisitIdAsc ? ('button.sortASC' | translate) : ('button.sortDES' | translate) }}</span> -->
                </button> 
              </th>
              <th>Title
                <button class="qm-transparent-btn" (click) = "sortByChange('TITLE')">
                  <i class="sort-icon" [ngClass]="((sortByCondition === 'EMAIL' && sortByAsc) || (sortByCondition !== 'EMAIL' && !sortByAsc)) ? 'icon-caret-down': 'icon-caret-up'"></i>
                  <!-- <span class="sr-only">{{ sortByVisitIdAsc ? ('button.sortASC' | translate) : ('button.sortDES' | translate) }}</span> -->
                </button> 
              </th>
              <th>Notes
                <button class="qm-transparent-btn" (click) = "sortByChange('NOTES')">
                  <i class="sort-icon" [ngClass]="((sortByCondition === 'PHONE' && sortByAsc) || (sortByCondition !== 'PHONE' && !sortByAsc)) ? 'icon-caret-down': 'icon-caret-up'"></i>
                  <!-- <span class="sr-only">{{ sortByVisitIdAsc ? ('button.sortASC' | translate) : ('button.sortDES' | translate) }}</span> -->
                </button> 
              </th>
              <th>User
                <button class="qm-transparent-btn" (click) = "sortByChange('USER')">
                  <i class="sort-icon" [ngClass]="((sortByCondition === 'UPDATED' && sortByAsc) || (sortByCondition !== 'UPDATED' && !sortByAsc)) ? 'icon-caret-down': 'icon-caret-up'"></i>
                  <!-- <span class="sr-only">{{ sortByVisitIdAsc ? ('button.sortASC' | translate) : ('button.sortDES' | translate) }}</span> -->
                </button> 
              </th>
            </tr>
            <tr *ngFor="let appointment of appointments | slice: (currentPage-1) * elementsPerPage : currentPage * elementsPerPage">
              <!-- <td>{{appointment.timeStamp | date}}</td> -->
              <td>{{appointment.timeStamp | amDateFormat: 'DD-MM-YYYY'}} <br>
                {{appointment.timeStamp | amDateFormat: 'hh:mm A'}}
              </td>
              <td>{{appointment.operation}}</td>
              <td> <a class="qm-table-link" (click)="appointmentSelected(appointment.entityId)"> {{appointment.entityId}}</a> </td>
              <td>{{extractValue(appointment.change).after.start | amDateFormat: 'DD-MM-YYYY'}} <br>
                {{extractValue(appointment.change).after.start | amDateFormat: 'hh:mm A'}}
              </td>
              <td>{{extractValue(appointment.change).after.end | amDateFormat: 'DD-MM-YYYY'}} <br>
                {{extractValue(appointment.change).after.end | amDateFormat: 'hh:mm A'}}
              </td>
              <td>{{mapBranch(appointment.branchId)}}</td>
              <td>{{extractValue(appointment.change).after.resource}}</td>
              <td>{{mapService(extractValue(appointment.change).after.services)}}</td>
              <td>{{extractValue(appointment.change).after.title}}</td>
              <td>{{extractValue(appointment.change).after.notes}}</td>
              <td>{{appointment.username}}</td>
            </tr>
          </table>
        </div>
        <div *ngIf="currentCustomer && appointments && appointments.length > 0"> Showing items from {{(currentPage - 1)*elementsPerPage + 1}} to {{currentPage*elementsPerPage}} of {{ fulAppointmentList.length }} items </div>
        <div class="qm-pagination-container">
          <ngb-pagination *ngIf="currentCustomer && appointments && appointments.length > 0" [(page)]="currentPage" [pageSize]="elementsPerPage" [collectionSize]="8" [maxSize]="10" [boundaryLinks]="true"></ngb-pagination>
        </div>
    
        <div class="qm-no-appointment" *ngIf="!currentCustomer">
          <div class="qm-no-appointment__text">
            Select a customer to view appointments
          </div>
        </div>
      </div>
      
      <div *ngIf="selectedAppointment && currentCustomer">
        <h2 class="qm-app-list-table-container__heading"  *ngIf="currentCustomer && appointments && appointments.length > 0">Visit Details</h2>
        <div style="width: 80%;margin: auto;">
          <div><span style="font-weight: bold;margin-right: 10px;">Name</span> <span *ngFor="let customer of selectedAppointment.customers">{{customer.name}}</span></div>
          <div><span style="font-weight: bold;margin-right: 10px;">Appointment Id</span> <span>{{selectedAppointment.id}}</span></div>
          <div><span style="font-weight: bold;margin-right: 10px;">Start Time</span> <span>{{selectedAppointment.start | amDateFormat: 'YY-MM-DD hh:mm A'}}</span></div>
          <div><span style="font-weight: bold;margin-right: 10px;">End Time</span> <span>{{selectedAppointment.end | amDateFormat: 'YY-MM-DD hh:mm A'}}</span></div>
          <div><span style="font-weight: bold;margin-right: 10px;">Branch</span> <span>{{selectedAppointment.branch.name}}</span></div>
          <div><span style="font-weight: bold;margin-right: 10px;">Resource</span> <span>{{selectedAppointment.resource.name}}</span></div>
          <button class="qm-btn qm-btn--primary" (click)="unSelectedAppointment()">Back</button>
        </div>
        <br><br>
        <div class="qm-app-list-table-container-list">
          <table id="app-list">
            <tr>
              <th>Action Time</th>  
              <th>Status</th>  
              <th>Queue</th>  
              <th>Service</th>
              <th>Outcome</th>
              <th>Mark</th>
              <th>Recycled Count</th>
              <th>Notes</th>
              <th>EntryPoint / ServicePoint</th>
              <th>User</th>
            </tr>
            <tr *ngFor="let visit of visitDataArray">
              <td>{{visit.time}}</td>
              <td>{{visit.visitOutcome}}</td>
              <td>{{visit.queue}}</td>
              <td>{{visit.service}}</td>
              <td>{{visit.outcome}}</td>
              <td>{{visit.mark}}</td>
              <td>{{visit.recycled}}</td>
              <td>{{visit.notes}}</td>
              <td>{{visit.workstation}}</td>
              <td>{{visit.user}}</td>
            </tr>  
          </table>
        </div>
      </div>
      
    
    </div>
  </qm-main>
  <qm-page-footer></qm-page-footer>
</div>
